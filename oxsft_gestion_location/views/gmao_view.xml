<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <data>

        <!-- tms_gmao_pm -->

        <record id="tms_gmao_pm_search" model="ir.ui.view">
            <field name="name">tms.gmao.pm.search</field>
            <field name="model">tms.gmao.pm</field>
            <field name="arch" type="xml">
                <search string="Recherche maintenance programmée">
                    <filter name="filter_new" string="Brouillon" icon="terp-stage" domain="[('state','=','new')]"
                            context="{}"/>
                    <filter name="filter_draft" string="Normal" icon="terp-stage" domain="[('state','=','draft')]"
                            context="{}"/>
                    <filter name="filter_left" string="Dépassé" icon="terp-stage" domain="[('state','=','left')]"
                            context="{}"/>
                    <filter name="filter_alert" string="Alerte" icon="terp-stage" domain="[('state','=','alert')]"
                            context="{}"/>
                    <filter name="filter_done" string="Validé" icon="terp-stage" domain="[('state','=','done')]"
                            context="{}"/>
                    <newline/>
                    <field name="name"/>
                    <field name="vehicle_id"/>
                    <newline/>
                    <group expand="0" string="Grouper par...">
                        <filter name="group_vehicle" string="Véhicule" icon="terp-stage" domain="[]"
                                context="{'group_by':'vehicle_id'}"/>
                        <filter name="group_type_alert" string="Type maintenance" icon="terp-personal" domain="[]"
                                context="{'group_by':'type_alert'}"/>
                        <filter name="group_service_type" string="Type intervention" icon="terp-stage" domain="[]"
                                context="{'group_by':'service_type_id'}"/>
                        <filter name="group_name_linked" string="Lien" icon="terp-stage" domain="[]"
                                context="{'group_by':'name_linked'}"/>
                        <filter name="group_state" string="Statut" icon="terp-stage" domain="[]"
                                context="{'group_by':'state'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- TEMPLATE MODÈLE D'ENTRETIEN -->
        <record id="view_tms_gmao_pm_model_template_form" model="ir.ui.view">
            <field name="name">tms.gmao.pm.model.template.form</field>
            <field name="model">tms.gmao.pm.model.template</field>
            <field name="arch" type="xml">
                <form string="Modèle d’alerte">
                    <sheet>
                        <group col="4" colspan="2">
                            <field name="name"/>
                            <field name="service_type_id" colspan="2" context="{'default_mro_ok':1}"/>
                            <field name="meter" colspan="2"/>
                            <field name="periodic"/>
                        </group>
                        <group col="4" colspan="4">
                            <separator string="Paramètres de la maintenance préventive" colspan="4"/>
                            <group col="2" colspan="2">
                                <field name="first_interval"/>
                                <field name="interval"/>
                                <field name="warning" string='Alerte en -'/>
                            </group>
                        </group>
                        <group string="Tolérance des écarts" col="6">
                            <field name="meter_ecart0"/>
                            <field name="meter_ecart"/>
                            <field name="valeur_ecart" string='Valeur en - '/>
                        </group>
                        <group string="Pièces prévues">
                            <field name="line_ids" nolabel="1">
                                <tree editable="bottom">
                                    <field name="product_id" domain="[('categ_id','=',%(mro.product_category_mro)d)]"
                                           context="{'default_categ_id':%(mro.product_category_mro)d}"/>
                                    <field name="product_qty"/>
                                </tree>
                            </field>
                        </group>
                    </sheet>
                </form>
            </field>
        </record>

        <record id="view_tms_gmao_pm_model_template_tree" model="ir.ui.view">
            <field name="name">tms.gmao.pm.model.template.tree</field>
            <field name="model">tms.gmao.pm.model.template</field>
            <field name="arch" type="xml">
                <tree string="Modèle d’alerte">
                    <field name="name"/>
                    <field name="service_type_id" context="{'default_mro_ok':1}"/>
                    <field name="meter" string="Unité"/>
                    <field name="periodic"/>
                    <field name="first_interval" string='1 ère échéance'/>
                    <field name="interval"/>
                    <field name="warning" string='Alerte en -'/>
                </tree>
            </field>
        </record>
        <!-- TEMPLATE MODÈLE D'ENTRETIEN -->

        <record id="view_tms_gmao_pm_model_form" model="ir.ui.view">
            <field name="name">tms.gmao.pm.model.form</field>
            <field name="model">tms.gmao.pm.model</field>
            <field name="arch" type="xml">
                <form string="Modèle d'alerte">
                    <sheet>
                        <group>
                            <group>
                                <field name="model_template_id" string="Modèle d’alerte"/>
                            </group>
                            <group></group>
                        </group>
                        <group col="4" colspan="2">
                            <field name="name" string="Libellé"/>
                            <field name="service_type_id" colspan="2" context="{'default_mro_ok':1}"/>
                            <field name="meter" colspan="2"/>
                            <field name="periodic"/>
                            <field name="pm_model_id" readonly="1"/>
                        </group>
                        <group col="4" colspan="4">
                            <separator string="Paramètres de la maintenance préventive" colspan="4"/>
                            <group col="2" colspan="2">
                                <field name="first_interval"/>
                                <field name="interval" string="Périodicité"/>
                                <field name="warning" string="Alerte en -"/>
                            </group>
                        </group>
                        <group string="Tolérance des écarts" col="6">
                            <field name="meter_ecart0"/>
                            <field name="meter_ecart"/>
                            <field name="valeur_ecart" string='Valeur en - '/>
                        </group>
                        <group string="Pièces prévues">
                            <field name="line_ids" nolabel="1">
                                <tree editable="bottom">
                                    <field name="product_id" domain="[('categ_id','=',%(mro.product_category_mro)d)]"
                                           context="{'default_categ_id':%(mro.product_category_mro)d}"/>
                                    <field name="product_qty"/>
                                </tree>
                            </field>
                        </group>
                    </sheet>
                </form>
            </field>
        </record>

        <record id="view_tms_gmao_pm_model_tree" model="ir.ui.view">
            <field name="name">tms.gmao.pm.model.tree</field>
            <field name="model">tms.gmao.pm.model</field>
            <field name="arch" type="xml">
                <tree>
                    <field name="name" string="Libellé"/>
                    <field name="service_type_id" context="{'default_mro_ok':1}"/>
                    <field name="meter" string="Unité"/>
                    <field name="periodic"/>
                    <field name="first_interval" string='1 ère échéance'/>
                    <field name="interval" string='Périodicité'/>
                    <field name="warning" string='Alerte en -'/>
                    <field name="pm_model_id"/>
                </tree>
            </field>
        </record>
        <!-- WIZARD ALERTE LIÉE -->
        <record id="view_tms_gmao_pm_link_form" model="ir.ui.view">
            <field name="name">tms.gmao.pm.link.form</field>
            <field name="model">tms.gmao.pm.link</field>
            <field name="arch" type="xml">
                <form>
                    <group>
                        <field name="active_pm_id" invisible="1"/>
                        <field name="linked_pm_id"
                               domain="[('vehicle_id','=',vehicle_id),('service_type_id','=',service_type_id),('pm_id','=',False),('id','!=',active_pm_id)]"
                               options="{'no_create':True}"/>
                        <field name="service_type_id" invisible="1" context="{'default_mro_ok':1}"/>
                        <field name="vehicle_id" invisible="1"/>
                    </group>
                    <footer>
                        <button string="Valider"
                                name="action_valider"
                                type="object"
                                class="oe_highlight"/>
                        or
                        <button string="Cancel"
                                class="oe_link"
                                special="cancel"/>
                    </footer>
                </form>
            </field>
        </record>

        <act_window id="tms_gmao_pm_link_action"
                    name="Alerte liée"
                    src_model="tms.gmao.pm"
                    res_model="tms.gmao.pm.link"
                    view_type="form" view_mode="form"
                    key2="client_action_multi" target="new"
        />
        <!-- WIZARD MODÈLE DE MAINTENANCE LIÉ -->
        <record id="view_tms_gmao_pm_model_link_form" model="ir.ui.view">
            <field name="name">tms.gmao.pm.model.link.form</field>
            <field name="model">tms.gmao.pm.model.link</field>
            <field name="arch" type="xml">
                <form>
                    <group>
                        <field name="pm_model_id1" domain="[('model_id','=',active_model_id),('id','!=',pm_model_id2)]"
                               options="{'no_create':1}"/>
                        <field name="pm_model_id2" domain="[('model_id','=',active_model_id),('id','!=',pm_model_id1)]"
                               options="{'no_create':1}"/>
                        <field name="active_model_id" invisible="1"/>
                    </group>
                    <footer>
                        <button string="Valider"
                                name="action_valider"
                                type="object"
                                class="oe_highlight"/>
                        or
                        <button string="Cancel"
                                class="oe_link"
                                special="cancel"/>
                    </footer>
                </form>
            </field>
        </record>

        <act_window id="tms_gmao_pm_model_link_action"
                    name="Lier modèle d’alerte"
                    src_model="fleet.vehicle.model"
                    res_model="tms.gmao.pm.model.link"
                    view_type="form" view_mode="form"
                    key2="client_action_multi" target="new"
        />
        <!-- FIN WIZARD -->

        <record id="view_tms_gmao_pm_form" model="ir.ui.view">
            <field name="name">tms.gmao.pm.form</field>
            <field name="model">tms.gmao.pm</field>
            <field name="arch" type="xml">
                <form string="Maintenances programmées">
                    <header>
                        <button name="generate_alert" string="Déclencher l'alerte"
                                attrs="{'invisible':['|',('state','!=','draft'),('draft_ok','=',False)]}" type="object"
                                groups="" class="oe_highlight"/>
                        <button name="end_periodic" string="Terminer périodicité"
                                attrs="{'invisible':['|','|',('periodic','=',False),('state','=','done'),('draft_ok','=',True)]}"
                                type="object" groups="" class="oe_highlight"/>
                        <button name="end_pm" string="Arrêter prévention"
                                attrs="{'invisible':['|',('state','=','done'),('draft_ok','=',True)]}" type="object"
                                groups="" class="oe_highlight"/>
                        <field name="state" widget="statusbar" statusbar_visible="draft,left,alert,done"/>
                    </header>
                    <sheet>
                        <group>
                            <group>
                                <h1>
                                    <field name="name" class="oe_inline" attrs="{'invisible': [('name','=','/')]}"
                                           readonly="1" required="True"/>
                                </h1>
                            </group>
                        </group>
                        <group>
                            <group>
                                <field name="model_template_id" string="Modèle d’alerte"
                                       attrs="{'readonly':[('draft_ok','!=',True)]}"/>
                            </group>
                            <group>
                                <field name="description" string="Libellé Alerte"/>
                            </group>
                        </group>
                        <group>
                            <group>
                                <field name="service_type_id" select="1" attrs="{'readonly':[('draft_ok','!=',True)]}"
                                       context="{'default_mro_ok':1}"/>
                                <field name="vehicle_id" required="1" attrs="{'readonly':[('draft_ok','!=',True)]}"/>
                                <field name="pm_id" readonly="1"/>
                                <field name="draft_ok" invisible="1"/>
                                <field name="maintenance_type" invisible="1"/>
                            </group>
                            <group>
                                <field name="meter" attrs="{'readonly':[('draft_ok','!=',True)]}" string="Unité :"/>
                                <field name="periodic" attrs="{'readonly':[('draft_ok','!=',True)]}"/>
                            </group>
                        </group>
                        <group>
                            <separator string="Paramètres de la maintenance préventive" colspan="4"/>
                            <group>
                                <field name="days_last_done" string="Début" select="1"
                                       attrs="{'invisible':[('meter','=','km')],'readonly':[('draft_ok','!=',True)]}"/>
                                <field name="km_last_done" string="Début" select="1"
                                       attrs="{'invisible':[('meter','!=','km')],'readonly':[('draft_ok','!=',True)]}"/>
                                <field name="first_interval" attrs="{'readonly':[('draft_ok','!=',True)]}"/>
                                <field name="interval" attrs="{'readonly':[('draft_ok','!=',True)]}"
                                       string="Périodicité"/>
                                <field name="warn_period_view" string="Alerte en -"/>
                            </group>
                            <group>
                                <field name="days_next_due" string="Prochaine visite"
                                       attrs="{'invisible':[('meter','=','km')]}"/>
                                <field name="km_next_due" string="Prochaine visite"
                                       attrs="{'invisible':[('meter','!=','km')]}"/>
                                <field name="left_view" string="Restants" invisible="1"/>
                                <field name="counter_current" string="Compteur actuel"
                                       attrs="{'invisible':[('meter','!=','km')]}"/>
                            </group>
                        </group>
                        <group string="Tolérance des écarts" col="6">
                            <field name="meter_ecart0" attrs="{'readonly':[('draft_ok','!=',True)]}"/>
                            <field name="meter_ecart" string="Type d’écart"
                                   attrs="{'readonly':[('draft_ok','!=',True)]}"/>
                            <field name="valeur_ecart" attrs="{'readonly':[('draft_ok','!=',True)]}"
                                   string='Valeur en - '/>
                        </group>
                        <notebook>
                            <page string="Suivi des alertes">
                                <field name="alert_ids" nolabel="1">
                                    <tree string="Suivi des historiques"
                                          colors="red:state == 'left' or state_process == 'cancel';blue:state == 'draft';green:state == 'done';orange:state == 'alert';"
                                          delete="false">
                                        <field name="name" select="1"/>
                                        <field name="date" select="1"/>
                                        <field name="last_done_view" string="Début"/>
                                        <field name="next_due_view" string="Prochaine visite"/>
                                        <field name="interval_view" string="Périodicité"/>
                                        <field name="left_view" invisible="1"/>
                                        <field name="warn_period_view" string="Alerte en -"/>
                                        <field name="left" invisible="True"/>
                                        <field name="meter" invisible="True"/>
                                        <field name="state" select="1"/>
                                        <field name="state_process" select="1"/>
                                        <button name="action_done_alert" string="Traiter" icon="fa-check" type="object"
                                                attrs="{'invisible':['|',('state_process','=','cancel'),('state','not in',('draft','left','alert'))]}"/>
                                        <button name="action_cancel_alert" string="Annuler" icon="fa-times-circle"
                                                type="object"
                                                attrs="{'invisible':['|',('state_process','=','cancel'),('state','not in',('draft','left','alert'))]}"/>
                                    </tree>
                                </field>
                            </page>
                            <page string="Pièces de rechange">
                                <field name="line_ids">
                                    <tree editable="bottom">
                                        <field name="product_id" string='Référence'
                                               domain="[('categ_id','=',%(mro.product_category_mro)d)]"
                                               context="{'default_categ_id':%(mro.product_category_mro)d}"/>
                                        <field name="product_qty"/>
                                    </tree>
                                </field>
                            </page>
                        </notebook>
                    </sheet>
                </form>
            </field>
        </record>

        <record id="view_tms_gmao_pm_tree" model="ir.ui.view">
            <field name="name">tms.gmao.pm.tree</field>
            <field name="model">tms.gmao.pm</field>
            <field name="type">tree</field>
            <field name="arch" type="xml">
                <tree colors="red:state == 'left';blue:state == 'draft';green:state == 'done';orange:state == 'alert';">
                    <field name="name" select="1"/>
                    <field name="description" string="Libellé Alerte"/>
                    <field name="vehicle_id" colspan="2" select="1"/>
                    <field name="last_done_view" string="Début"/>
                    <field name="next_due_view" string="Prochaine visite"/>
                    <field name="interval_view" string="Périodicité"/>
                    <field name="left_view" invisible="1"/>
                    <field name="warn_period" invisible="1"/>
                    <field name="warn_period_view" string="Alerte en -"/>
                    <field name="type_alert" string="Type d’alerte"/>
                    <field name="left" invisible="1"/>
                    <field name="meter" invisible="1"/>
                    <field name="state" string="statut"/>
                    <field name="service_type_id" invisible="1" context="{'default_mro_ok':1}"/>
                </tree>
            </field>
        </record>


        <!-- tms_gmao_pm_alert -->

        <record id="vtms_gmao_pm_alert_calendar" model="ir.ui.view">
            <field name="name">tms.gmao.pm.alert.calendar</field>
            <field name="model">tms.gmao.pm.alert</field>
            <field eval="2" name="priority"/>
            <field name="arch" type="xml">
                <calendar color="vehicle_id" date_start="days_next_due" string="Alerte">
                    <field name="vehicle_id"/>
                    <field name="type_alert"/>
                </calendar>
            </field>
        </record>

        <record id="tms_gmao_pm_alert_search" model="ir.ui.view">
            <field name="name">tms.gmao.pm.alert.search</field>
            <field name="model">tms.gmao.pm.alert</field>
            <field name="arch" type="xml">
                <search string="Recherche alertes">
                    <filter name="filter_calendar" string="Calendrier" icon="terp-stage"
                            domain="[('meter','in',('annee','mois','days','horaire')),('vehicle_id.planning','=',True)]"
                            context="{'calendar_view_ref':'tms_gmao_pm_alert_calendar'}"/>
                    <separator/>
                    <filter name="filter_draft" string="Normal" icon="terp-stage" domain="[('state','=','draft')]"
                            context="{}"/>
                    <filter name="filter_left" string="Dépassé" icon="terp-stage" domain="[('state','=','left')]"
                            context="{}"/>
                    <filter name="filter_alert" string="Alerte" icon="terp-stage" domain="[('state','=','alert')]"
                            context="{}"/>
                    <filter name="filter_done" string="Validé" icon="terp-stage" domain="[('state','=','done')]"
                            context="{}"/>
                    <separator orientation="vertical"/>
                    <filter name="filter_progress" string="En cours" icon="terp-stage"
                            domain="[('state_process','=','progress')]" context="{}"/>
                    <filter name="filter_cancel" string="Annulé" icon="terp-stage"
                            domain="[('state_process','=','cancel')]" context="{}"/>
                    <newline/>
                    <field name="name"/>
                    <field name="pm_id"/>
                    <field name="vehicle_id"/>
                    <newline/>
                    <group expand="0" string="Grouper par...">
                        <filter name="group_vehicle" string="Véhicule" icon="terp-stage" domain="[]"
                                context="{'group_by':'vehicle_id'}"/>
                        <filter name="group_pm" string="Maintenance programmée" icon="terp-personal" domain="[]"
                                context="{'group_by':'pm_id'}"/>
                        <filter name="group_type_alert" string="Type maintenance" icon="terp-personal" domain="[]"
                                context="{'group_by':'type_alert'}"/>
                        <filter name="group_state_process" string="Etat traitement" icon="terp-stage" domain="[]"
                                context="{'group_by':'state_process'}"/>
                    </group>
                </search>
            </field>
        </record>


        <record id="tms_gmao_pm_alert_tree" model="ir.ui.view">
            <field name="name">tms.gmao.pm.alert.tree</field>
            <field name="model">tms.gmao.pm.alert</field>
            <field name="arch" type="xml">
                <tree string="Alertes"
                      colors="red:state == 'left' or state_process == 'cancel';blue:state == 'draft';green:state == 'done';orange:state == 'alert';">
                    <field name="name"/>
                    <field name="pm_id" string="Maintenance programmée"/>
                    <field name="description" string="Libellé Alerte"/>
                    <field name="license_plate"/>
                    <field name="vehicle_id"/>
                    <field name="date"/>
                    <field name="last_done_view" string="Début"/>
                    <field name="next_due_view" string="Prochaine visite"/>
                    <field name="interval_view" string="Périodicité"/>
                    <field name="left_view" invisible="1"/>
                    <field name="warn_period_view" string="Alerte en -"/>
                    <field name="left" invisible="True"/>
                    <field name="meter" invisible="True"/>
                    <field name="type_alert" string="Type d’alerte"/>
                    <field name="state" string="Statut"/>
                    <field name="state_process"/>
                    <button name="action_done_alert" string="Traiter" icon="gtk-go-forward" type="object"
                            attrs="{'invisible':['|',('state_process','=','cancel'),('state','not in',('draft','left','alert'))]}"
                            groups=""/>
                    <button name="action_cancel_alert" string="Annuler" icon="gtk-cancel" type="object"
                            attrs="{'invisible':['|',('state_process','=','cancel'),('state','not in',('draft','left','alert'))]}"
                            confirm="Annuler l'alerte ?" groups=""/>
                </tree>
            </field>
        </record>

        <record id="tms_gmao_pm_alert_form" model="ir.ui.view">
            <field name="name">tms.gmao.pm.alert.form</field>
            <field name="model">tms.gmao.pm.alert</field>
            <field name="arch" type="xml">
                <form string="Alertes">
                    <header>
                        <button name="action_done_alert" string="Traiter" type="object"
                                attrs="{'invisible':['|',('state_process','=','cancel'),('state','not in',('draft','left','alert'))]}"
                                groups=""/>
                        <button name="action_cancel_alert" string="Annuler" type="object"
                                attrs="{'invisible':['|',('state_process','=','cancel'),('state','not in',('draft','left','alert'))]}"
                                confirm="Annuler l'alerte ?" groups=""/>
                        <field name="state" widget="statusbar" statusbar_colors='{}'/>
                    </header>
                    <sheet>
                        <h1>
                            <field name="name" class="oe_inline" attrs="{'invisible': [('name','=','/')]}" readonly="1"
                                   required="True"/>
                        </h1>
                        <group colspan="4" col="4">
                            <field name="pm_id" string="Maintenance programmée"/>
                            <field name="vehicle_id" colspan="2" select="1"/>
                            <field name="type_alert"/>
                            <field name="date"/>
                            <field name="description" string="Libellé Alerte"/>
                            <field name="state_process" invisible="1"/>
                        </group>

                        <group colspan="4" col="4">
                            <field name="interval_view" string="Périodicité"/>
                            <field name="last_done_view" string="Début"/>
                            <field name="next_due_view" string="Prochaine visite"/>
                            <field name="warn_period_view" string='Alerte en -'/>
                            <field name="left_view" invisible="1"/>
                        </group>
                        <newline/>
                        <notebook colspan="4">
                            <page string="Maintenances ( OR )">
                                <field name="maintenance_ids" nolabel="1">
                                    <tree colors="">
                                        <field name="name" readonly="True"/>
                                        <field name="maintenancier_id"/>
                                        <field name="maintenance_type"/>
                                        <field name="vehicle_id"/>
                                        <field name="service_type_id" context="{'default_mro_ok':1}"/>
                                        <field name="state"/>
                                    </tree>
                                </field>
                            </page>
                        </notebook>
                    </sheet>
                </form>
            </field>
        </record>

    </data>
</odoo>
